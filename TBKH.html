<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thông Báo Gửi Khách Hàng</title>

  <!-- Thư viện đọc file Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Thư viện chụp màn hình HTML thành ảnh -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    /* --- CSS cơ bản: căn chỉnh giao diện --- */
    body {
      font-family: 'Times New Roman', Times, serif;
      padding: 40px;
      background-color: #f0f4f8;
    }
    .container {
      max-width: 800px;
      margin: auto;
      text-align: center;
    }
    textarea, input, button {
      font-family: 'Times New Roman', Times, serif;
      font-size: 16px;
    }
    #preview {
      background-color: #eeeeee;
      padding: 30px;
      margin-top: 30px;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: left;
      line-height: 1.6;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    .logo {
      color: #007bff;
      font-weight: bold;
    }
    .center { text-align: center; }
    .bold { font-weight: bold; }
    .italic { font-style: italic; }
    .highlight-red { color: red; font-weight: bold; }
    .note { font-size: 13px; color: gray; }
  </style>
</head>

<body>
<div class="container">
  <h2>Thông báo gửi khách hàng</h2>

  <!-- Chọn file Excel -->
  <input type="file" id="excel-file" accept=".xlsx, .xls" /><br><br>

  <!-- Các ô nhập dữ liệu -->
  <input type="text" id="shd-input" placeholder="Nhập SHD để tìm" /><br>
  <input type="text" id="lastpayday-input" placeholder="Ngày ngưng thanh toán (dd/mm/yyyy)" /><br>
  <input type="text" id="deadline-input" placeholder="Ngày chốt ngân sách (dd/mm/yyyy)" /><br><br>

  <!-- Các nút chức năng -->
  <button onclick="generateNotice()">Tạo Thông Báo</button>
  <button onclick="copyTBKH()" style="background-color:#28a745;">TBKH</button>
  <button onclick="copyCACHTHANHTOAN()" style="background-color:#ffc107; color:black;">CÁCH THANH TOÁN</button>
  <button onclick="copyTBTHAMCHIEU()" style="background-color:#dc3545;">THAM CHIẾU</button>
<!-- Link quay lại Trang chủ -->
  <a href="index.html" class="link-back">← Quay về Trang chủ</a>
</div>
  <!-- Khu vực hiển thị nội dung preview -->
  <div id="preview" style="display:none;"></div>
</div>

<script>
// Biến lưu dữ liệu khách hàng từ file Excel
let customerData = [];

/* --- Đọc file Excel và lưu dữ liệu vào biến --- */
document.getElementById('excel-file').addEventListener('change', function(e) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    customerData = XLSX.utils.sheet_to_json(sheet);
    alert('Đã tải dữ liệu từ Excel!');
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

/* --- Hàm chuẩn hóa số điện thoại --- */
function formatPhoneNumber(phone) {
  phone = phone.toString();
  if (phone.startsWith("84")) return "0" + phone.slice(2);
  if (phone.length === 9 && phone[0] !== '0') return "0" + phone;
  return phone;
}

/* --- Hàm kiểm tra giá trị ngày tháng hợp lệ từ Excel --- */
function isValidExcelDate(val) {
  return typeof val === 'number' && val > 40000 && val < 60000;
}

/* --- Hàm chuyển ngày Excel thành chuỗi dd/mm/yyyy --- */
function excelDateToString(excelDate) {
  if (!isValidExcelDate(excelDate)) return null;
  const date = new Date((excelDate - 25569) * 86400 * 1000);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

/* --- Hàm copy text vào clipboard --- */
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).catch(() => {
    alert('Copy thất bại!');
  });
}

/* --- Tạo thông báo + copy hình ảnh vào clipboard --- */
async function generateNotice() {
  const shd = document.getElementById('shd-input').value.trim();
  const lastpayInput = document.getElementById('lastpayday-input').value.trim();
  const deadlineInput = document.getElementById('deadline-input').value.trim();
  const record = customerData.find(r => r.SHD == shd);
  const preview = document.getElementById('preview');

  if (!record) {
    preview.innerHTML = '<p style="color:red;">Không tìm thấy SHD phù hợp.</p>';
    preview.style.display = 'block';
    return;
  }

  // Lấy ngày hiện tại
  const now = new Date();
  const currentDate = `Thành phố Hồ Chí Minh, ngày ${now.getDate().toString().padStart(2, '0')} tháng ${(now.getMonth() + 1).toString().padStart(2, '0')} năm ${now.getFullYear()}`;

  // Xử lý ngày thanh toán và hạn chót
  const lastpayday = lastpayInput || excelDateToString(record.LASTPAYDAY);
  const deadline = deadlineInput || excelDateToString(record.DAPTTP);

  // Định dạng số tiền
  const amountFormatted = Number(record.AMOUNT).toLocaleString('en-US');
  const posFormatted = `<b>${Number(record.POS).toLocaleString('en-US')}</b>`;
  const phoneFormatted = formatPhoneNumber(record.SDT);

  let deadlineLine = "";
  if (deadline) {
    deadlineLine = `<i>(Thời gian chốt ngân sách: đã bảo lãnh gia hạn đến ngày: ${deadline})</i><br><br>`;
  }

  // Nội dung HTML thông báo
  const html = `
    <div class="logo">Galaxy <span class="bold" style="color:#1b4de4;">Debt Trading</span></div>
    <p class="center bold">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM<br>
    Độc lập – Tự do – Hạnh phúc<br>
    ------------------------------<br>
    <i>${currentDate}</i></p>

    <p class="center bold" style="font-size: 20px;">THÔNG BÁO KHẨN</p>

    <p><i>Kính gửi khách hàng: </i><b>${record.TENKH}</b><br>
      Số CMND/CCCD: [${record.CCCD}] - Số điện thoại liên hệ: [${phoneFormatted}]<br>
      <span class="highlight-red">Địa chỉ: ${record.DIACHI}</span><br>

      Phòng Quản lý Tài sản GALAXY Debt Trading <b>ủy quyền khởi kiện</b> xin thông báo đến quý khách hàng nội dung như sau:<br>

      Căn cứ hợp đồng số: <b>[${record.SHD}]</b> giữa <b>[${record.DONVI}]</b> và Quý khách hàng. <b>Ngưng thanh toán</b> từ ngày <b>${lastpayday}</b> đến nay.<br>

      - Số tiền quá hạn: <b>${amountFormatted} (VNĐ)</b><br>
      - Ngân sách giảm 100% lãi phí phát thanh lý hợp đồng: ${posFormatted} (VNĐ)<br>
      ${deadlineLine}
<div>
      Galaxy đã nhiều lần cố gắng liên lạc với Quý khách hàng qua điện thoại, thậm chí đã cho Chuyên viên Quản lý & Xử lý nợ xấu đến tận nhà gặp gỡ để tìm hiểu và yêu cầu Quý khách hàng thanh toán khoản vay đúng hạn. Tuy nhiên đến đến nay Quý khách hàng vẫn chưa thực hiện nghiêm túc nghĩa vụ thanh toán với ${record.DONVI} và Quý khách hàng có thái độ: <b>Trốn tránh trách nhiệm, cố tình chây ỳ không thanh toán </b><br><br>

      Do đó, thông báo này: <b>Galaxy yêu cầu Quý khách hàng</b> cần cân đối tài chính,phải Phải thực hiện ngay nghĩa vụ thanh toán của mình đúng như đã cam kết trong Hợp đồng tín dụng và liên hệ ngay với chúng tôi để xử lý món nợ nêu trên.<br><br>

      Trong trường hợp Quý khách hàng vẫn không thanh toán khoản vay và không liên lạc lại. Galaxy sẽ chuyển hồ sơ của Quý khách hàng sang bộ phận tố tụng để điều tra, khởi kiện về hành vi: <b>Lạm dụng tín nhiệm chiếm đoạt tài sản</b> theo quy định tại khoản 1, điểm C khoản 2 theo điều <b>175 Bộ luật hình sự,</b> hoặc tội <b>Lừa đảo chiếm đoạt tài sản theo 174 bộ luật hình sự</b><div>

      <span class="highlight-red">Mọi vấn đề liên quan đến nội dung thông báo, xin vui lòng liên hệ:</span><br>
      Cán bộ thụ lý: Dương Minh Hoàng<br><br>

      <div style="float:right;" class="bold">BP.PHÒNG: QUẢN LÝ TÀI SẢN<br>(*Đã ký)</div><br><br>

      <div class="note">
      *Thông báo này xuất từ hệ thống, bản Scan không ký đóng dấu. Nếu có thắc mắc, vui lòng liên hệ Hotline: 034 882 0113
      </div>
    `;

  preview.innerHTML = html;
  preview.style.display = 'block';

  // --- Chụp và copy hình ảnh vào clipboard ---
  await new Promise(resolve => setTimeout(resolve, 300)); // đợi render xong
  html2canvas(preview, { scale: 2 }).then(canvas => {
    canvas.toBlob(blob => {
      navigator.clipboard.write([
        new ClipboardItem({ "image/png": blob })
      ]).then(() => {
        alert('Đã tạo và copy hình ảnh vào clipboard!');
      }).catch(() => {
        alert('Không thể copy hình ảnh.');
      });
    });
  });
}

/* --- Copy mẫu tin nhắn "Thông báo khách hàng" --- */
function copyTBKH() {
  const shd = document.getElementById('shd-input').value.trim();
  const record = customerData.find(r => r.SHD == shd);
  if (!record) { alert('Không tìm thấy SHD phù hợp!'); return; }

  const text = `*Bên chỗ Anh Hoàng/sđt 034 882 0113 (Phòng pháp lý) hoàn tất thủ tục hòa giải: xin trả gốc - giảm 100% lãi phí, xin Giấy Xóa Nợ trên CIC.
*Hồ sơ bị nghi ngờ: LẠM DỤNG TÍN NHIỆM CHIẾM ĐOẠT TÀI SẢN.
Nhắn: ${record.TENKH} liên hệ trước 10h sáng mai để giải quyết.
(Tổng nợ: ${Number(record.AMOUNT).toLocaleString()} VNĐ)`;
  
  copyToClipboard(text);
}

/* --- Copy mẫu tin nhắn "Cách thanh toán" --- */
function copyCACHTHANHTOAN() {
  const text = `- Kiểm tra hồ sơ Đơn kiện: 19006535 - 1900 999 903.
- Phương thức Thanh toán: Ngân hàng / Bưu điện / Viettel / Thế giới di động / MoMo.`;
  
  copyToClipboard(text);
}

/* --- Copy mẫu tin nhắn "Tham chiếu" --- */
function copyTBTHAMCHIEU() {
  const shd = document.getElementById('shd-input').value.trim();
  const record = customerData.find(r => r.SHD == shd);
  if (!record) { alert('Không tìm thấy SHD phù hợp!'); return; }

  const text = `Nhờ nhắn: ${record.TENKH} _CCCD/CMND: ${record.CCCD}_ địa chỉ: ${record.DIACHI}.
Liên hệ Anh Hoàng (034 882 0113) để giải quyết đơn kiện - Hòa giải.
(Mã hồ sơ ${record.SHD} vướng bên ${record.DONVI}).
Tổng nợ: ${Number(record.AMOUNT).toLocaleString()} VNĐ.`;
  
  copyToClipboard(text);
}
</script>

</body>
</html>
