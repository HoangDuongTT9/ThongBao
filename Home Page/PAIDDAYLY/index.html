<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thông Báo Gửi Khách Hàng</title>

  <!-- Thư viện đọc file Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Thư viện chụp màn hình HTML thành ảnh -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    /* --- Giao diện hiện đại, thân thiện --- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8fafc;
      color: #333;
      margin: 0;
      padding: 40px 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    input[type="file"], input[type="text"] {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    button {
      background-color: #3498db;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    #preview {
      background-color: #f0f4f8;
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow-x: auto;
      display: none;
    }
    .link-back {
      display: block;
      text-align: center;
      margin-top: 30px;
      text-decoration: none;
      color: #3498db;
      font-weight: bold;
    }
    .link-back:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

<div class="container">
  <h2>Thông Báo Gửi Khách Hàng</h2>

  <!-- Khu vực upload file Excel -->
  <input type="file" id="excel-file" accept=".xlsx, .xls" />

  <!-- Các ô nhập dữ liệu -->
  <input type="text" id="shd-input" placeholder="Nhập Số Hợp Đồng (SHD)" />
  <input type="text" id="lastpayday-input" placeholder="Ngày ngưng thanh toán (dd/mm/yyyy)" />
  <input type="text" id="deadline-input" placeholder="Ngày chốt ngân sách (dd/mm/yyyy)" />

  <!-- Các nút thao tác -->
  <div class="button-group">
    <button onclick="generateNotice()">Tạo Thông Báo</button>
    <button onclick="copyTBKH()">Copy TBKH</button>
    <button onclick="copyCACHTHANHTOAN()">Copy Cách Thanh Toán</button>
    <button onclick="copyTBTHAMCHIEU()">Copy Tham Chiếu</button>
  </div>

  <!-- Khu vực hiển thị preview -->
  <div id="preview"></div>

  <!-- Link quay lại Trang chủ -->
  <a href="../" class="link-back">← Quay về Trang chủ</a>
</div>

<script>
/* --- Biến lưu dữ liệu từ Excel --- */
let customerData = [];

/* --- Load dữ liệu từ LocalStorage nếu có --- */
if (localStorage.getItem('customerData')) {
  customerData = JSON.parse(localStorage.getItem('customerData'));
  console.log('Đã nạp dữ liệu từ bộ nhớ trình duyệt.');
}

/* --- Sự kiện: Chọn file Excel --- */
document.getElementById('excel-file').addEventListener('change', function(e) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    customerData = XLSX.utils.sheet_to_json(sheet);

    // Lưu dữ liệu vào LocalStorage
    localStorage.setItem('customerData', JSON.stringify(customerData));

    alert('✅ Đã tải dữ liệu từ Excel và lưu vào bộ nhớ!');
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

/* --- Chuẩn hóa số điện thoại --- */
function formatPhoneNumber(phone) {
  phone = phone.toString();
  if (phone.startsWith("84")) return "0" + phone.slice(2);
  if (phone.length === 9 && phone[0] !== '0') return "0" + phone;
  return phone;
}

/* --- Kiểm tra ngày hợp lệ từ Excel --- */
function isValidExcelDate(val) {
  return typeof val === 'number' && val > 40000 && val < 60000;
}

/* --- Chuyển đổi ngày từ định dạng Excel sang chuỗi dd/mm/yyyy --- */
function excelDateToString(excelDate) {
  if (!isValidExcelDate(excelDate)) return null;
  const date = new Date((excelDate - 25569) * 86400 * 1000);
  return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
}

/* --- Copy text vào clipboard --- */
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).catch(() => alert('❌ Copy thất bại!'));
}

/* --- Tạo Thông báo và Copy hình ảnh --- */
async function generateNotice() {
  const shd = document.getElementById('shd-input').value.trim();
  const record = customerData.find(r => r.SHD == shd);
  const preview = document.getElementById('preview');

  if (!record) {
    preview.innerHTML = '<p style="color:red;">Không tìm thấy SHD phù hợp.</p>';
    preview.style.display = 'block';
    return;
  }

  const now = new Date();
  const currentDate = `Thành phố Hồ Chí Minh, ngày ${now.getDate().toString().padStart(2, '0')} tháng ${(now.getMonth() + 1).toString().padStart(2, '0')} năm ${now.getFullYear()}`;

  const lastpayday = document.getElementById('lastpayday-input').value.trim() || excelDateToString(record.LASTPAYDAY);
  const deadline = document.getElementById('deadline-input').value.trim() || excelDateToString(record.DAPTTP);

  const amountFormatted = Number(record.AMOUNT).toLocaleString('en-US');
  const posFormatted = `<b>${Number(record.POS).toLocaleString('en-US')}</b>`;
  const phoneFormatted = formatPhoneNumber(record.SDT);

  let deadlineLine = "";
  if (deadline) {
    deadlineLine = `<i>(Thời gian chốt ngân sách: đã gia hạn đến ngày ${deadline})</i><br><br>`;
  }

  const html = `
    <div style="text-align:center;font-weight:bold;">Galaxy Debt Trading</div><br>
    <div style="text-align:center;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM<br>Độc lập – Tự do – Hạnh phúc<br>--------------------</div>
    <div style="text-align:center;"><i>${currentDate}</i></div><br>
    <div style="text-align:center;font-size:20px;font-weight:bold;">THÔNG BÁO KHẨN</div><br>
    <div><i>Kính gửi:</i> <b>${record.TENKH}</b><br>
    Số CMND/CCCD: ${record.CCCD} - Số điện thoại: ${phoneFormatted}<br>
    <span style="color:red;font-weight:bold;">Địa chỉ: ${record.DIACHI}</span><br><br>
    Căn cứ hợp đồng số: <b>${record.SHD}</b> với <b>${record.DONVI}</b>, hiện tại Quý khách đã <b>ngưng thanh toán</b> từ ngày <b>${lastpayday}</b> đến nay.<br><br>
    - Số tiền quá hạn: <b>${amountFormatted} VNĐ</b><br>
    - Ngân sách hỗ trợ: ${posFormatted} VNĐ<br>
    ${deadlineLine}
    </div>
  `;

  preview.innerHTML = html;
  preview.style.display = 'block';

  // --- Copy hình ảnh vào clipboard ---
  await new Promise(resolve => setTimeout(resolve, 300));
  html2canvas(preview, { scale: 2 }).then(canvas => {
    canvas.toBlob(blob => {
      navigator.clipboard.write([
        new ClipboardItem({ "image/png": blob })
      ]).then(() => {
        alert('✅ Đã copy hình ảnh vào clipboard!');
      }).catch(() => {
        alert('❌ Không thể copy hình ảnh!');
      });
    });
  });
}

/* --- Các hàm Copy tin nhắn --- */
function copyTBKH() {
  const shd = document.getElementById('shd-input').value.trim();
  const record = customerData.find(r => r.SHD == shd);
  if (!record) { alert('Không tìm thấy SHD phù hợp!'); return; }
  const text = `*Thông báo khách hàng: ${record.TENKH}, nợ ${Number(record.AMOUNT).toLocaleString()} VNĐ, vui lòng liên hệ xử lý.`;
  copyToClipboard(text);
}
function copyCACHTHANHTOAN() {
  const text = `- Kiểm tra hồ sơ: Hotline 1900 999 903.\n- Thanh toán: Ngân hàng / Bưu điện / Viettel / MoMo.`;
  copyToClipboard(text);
}
function copyTBTHAMCHIEU() {
  const shd = document.getElementById('shd-input').value.trim();
  const record = customerData.find(r => r.SHD == shd);
  if (!record) { alert('Không tìm thấy SHD phù hợp!'); return; }
  const text = `Nhờ liên hệ: ${record.TENKH}, CMND/CCCD: ${record.CCCD}, địa chỉ: ${record.DIACHI}, để xử lý hồ sơ đơn kiện.`;
  copyToClipboard(text);
}
</script>

</body>
</html>
